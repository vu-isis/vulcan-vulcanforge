{% extends g.templates['master'] %}
{% set has_related_artifacts = True %}

{% do g.resource_manager.register_css('artifact/artifact.scss') %}
{% do g.resource_manager.register_css('css/hilite.css') %}
{% do g.resource_manager.register_css('assets/filebrowser/filebrowserwidget.css') %}

{% do g.resource_manager.register_js('js/lib/jquery/jquery.qtip.js', scope='tool') %}
{% do g.resource_manager.register_js('artifact/Artifact.js') %}
{% do g.resource_manager.register_js('assets/filebrowser/filebrowserwidget.js') %}

{% block extra_js %}
<script type="text/javascript">
    $vf.afterInit(function () {
        var $fileBrowser;
        var restServicePath = "/rest{{c.app.config.url()}}content";
        var editable = {{ editable|lower }};

        $vf.deleteContent = function(path){
            var object_type = 'file';
            if (RegExp(/\/$/i).test(path)){
                object_type = 'folder';
            }
            var go = confirm("Are you certain you want to delete this "+object_type+"?");
            if (go === true) {
                var fbWidget = $fileBrowser.data('fileBrowser');
                fbWidget.lockInterface("Working...");
                $.ajax({
                    url: restServicePath + path,
                    type: 'DELETE',
                    data: {
                        _session_id: $.cookie('_session_id')
                    },
                    dataType: "json",
                    success: function () {
                        fbWidget.unlockInterface();
                        $vf.webflash();
                        fbWidget.refreshActivePath();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        fbWidget.unlockInterface();
                        $vf.ajaxErrorHandler(jqXHR, textStatus, errorThrown);
                    }
                });
            }
            return false;
        };

        $vf.createFolder = function(path, folderName){
            var fbWidget = $fileBrowser.data('fileBrowser');
            fbWidget.lockInterface("Working...");
            $.ajax({
                url: restServicePath,
                type: 'POST',
                data: {
                    _session_id: $.cookie('_session_id'),
                    'path': path,
                    'folder': folderName
                },
                dataType: "json",
                success: function () {
                    fbWidget.unlockInterface();
                    $vf.webflash();
                    fbWidget.refreshActivePath();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    fbWidget.unlockInterface();
                    $vf.ajaxErrorHandler(jqXHR, textStatus, errorThrown);
                }
            });
        };

        $fileBrowser = $('#fileBrowserWidget').fileBrowser({
            assertions: true,

            pageTitleFormat: "{{ c.project.name }} / " +
                    "{{ c.app.config.options.mount_label }} / " +
                    "{path}",

            extraFields: ['size', 'actions'],
            initialPath: '{{fd_folder.item_key}}',
            contentRootPath: '{{content_root_path}}',
            canUpload: editable,

            getURLForPath: function (path) {
                var url = restServicePath;
                if (path.substring(0, 1) !== '/') {
                    url += '/';
                }
                url += path;
                return url;
            },

            getDataForPath: function (path, callback) {
                var url, dataURL, i, resultItem, actionList;
                var that = this;

                $.ajax({
                    url: restServicePath+path,
                    type: 'GET',
                    context: this,
                    dataType: 'json',
                    success: function(result) {
                        $.each(result, function (path, resultItem) {
                            resultItem['href'] = that.contentRootPath+resultItem['path'];
                            actionList = $('<p/>');
                            if (editable){
                                $('<a/>', {
                                    'class': "del_bin ico-delete icon",
                                    'title': "Delete",
                                    'href': "",
                                    'onclick': "$vf.deleteContent(\'"+resultItem['path']+"\'); return false;"
                                }).appendTo(actionList);
                            }
                            if (resultItem.type == 'FILE'){
                                $('<a/>', {
                                    'class': "ico-download icon",
                                    'title': "Download",
                                    'href': restServicePath+resultItem['path']
                                }).appendTo(actionList);
                            }
                            resultItem.extra.actions = actionList.html();
                        });
                        callback(result);
                    },
                    error: $vf.ajaxErrorHandler
                });
            },

            getUploadFormDataForFileAndPath: function (file, path) {
                var formData = new FormData();
                formData.append("file", file);
                formData.append("path", path);
                return formData;
            },

            getUploadURLForFileAndPath: function (file, path) {
                return restServicePath;
            },

            alert: function (opt) {
                var message = typeof(opt) == 'string' ? opt : '';
                if (opt.title != undefined) {
                    message += opt.title + '\n\n';
                }
                if (opt.message != undefined) {
                    message += opt.message;
                }
                if (message.length > 0) {
                    alert(message);
                    window.location.href = this.contentRootPath+'/';
                }
            },

            folderOperations: [
                function (pathData) {
                    if (!editable){
                        return false;
                    }
                    return $('<button>New Folder</button>').
                            addClass('inline-icon ico-plus').
                            attr('title', 'New Folder').
                            bind('click', function () {
                                var modalContainer = $('<div/>', {
                                    title:'New Folder'
                                });
                                var form = $('<form/>').appendTo(modalContainer);
                                $('<label/>', {
                                    text:'Folder name'
                                }).appendTo(form);
                                var input_field = $('<input/>', {
                                    type:'text',
                                    name:'folder_name',
                                    'id':'folder_name'
                                }).appendTo(form);
                                form.bind('submit', function (e) {
                                    modalContainer.dialog("close");
                                    $vf.createFolder(pathData.path, input_field.val());
                                    e.preventDefault();
                                });

                                modalContainer.dialog({
                                    modal:true,
                                    buttons:{
                                        Apply:function () {
                                            form.trigger('submit');
                                        },
                                        Cancel:function () {
                                            modalContainer.dialog("close");
                                        }
                                    },
                                    zIndex:10501
                                });

                                return false;
                            });
                }
            ]
        });
    });
</script>
{{ super() }}
{% endblock %}

{% block title %}
{{ c.project.name }} / {{ c.app.config.options.mount_label }} /
{% endblock %}

{% block header %}
Browsing Content
{% endblock %}

{% block relatedArtifacts %}
{{c.related_artifacts_widget.display(value=fd_folder)}}
{% endblock %}

{% block content %}
<div id="fileBrowserWidget" class="padded top-spaced"></div>
{% endblock %}

