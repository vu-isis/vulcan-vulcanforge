<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>vulcanforge.auth.model &mdash; Vulcan 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature-theme-extended.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Vulcan 0.1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Vulcan 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for vulcanforge.auth.model</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">markupsafe</span> <span class="kn">import</span> <span class="n">Markup</span>
<span class="kn">import</span> <span class="nn">simplejson</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">iso8601</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">header</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span><span class="p">,</span> <span class="n">app_globals</span> <span class="k">as</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">tg</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">flash</span>
<span class="kn">from</span> <span class="nn">ming</span> <span class="kn">import</span> <span class="n">schema</span> <span class="k">as</span> <span class="n">S</span>
<span class="kn">from</span> <span class="nn">ming.odm</span> <span class="kn">import</span> <span class="n">session</span><span class="p">,</span> <span class="n">state</span>
<span class="kn">from</span> <span class="nn">ming.odm</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FieldProperty</span><span class="p">,</span>
    <span class="n">RelationProperty</span><span class="p">,</span>
    <span class="n">ForeignIdProperty</span><span class="p">,</span>
    <span class="n">Mapper</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ming.odm.declarative</span> <span class="kn">import</span> <span class="n">MappedClass</span>
<span class="kn">from</span> <span class="nn">ming.utils</span> <span class="kn">import</span> <span class="n">LazyProperty</span>
<span class="kn">from</span> <span class="nn">vulcanforge.common.model.base</span> <span class="kn">import</span> <span class="n">BaseMappedClass</span>
<span class="kn">from</span> <span class="nn">vulcanforge.common.model.globals</span> <span class="kn">import</span> <span class="n">ForgeGlobals</span>

<span class="kn">from</span> <span class="nn">vulcanforge.common.model.index</span> <span class="kn">import</span> <span class="n">SOLRIndexed</span>
<span class="kn">from</span> <span class="nn">vulcanforge.common.model.session</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">solr_indexed_session</span><span class="p">,</span>
    <span class="n">main_orm_session</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">vulcanforge.common</span> <span class="kn">import</span> <span class="n">helpers</span> <span class="k">as</span> <span class="n">h</span>
<span class="kn">from</span> <span class="nn">vulcanforge.common.util</span> <span class="kn">import</span> <span class="n">get_client_ip</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">cryptographic_nonce</span>
<span class="c">#from vulcanforge.project.model import Project, ProjectRole</span>
<span class="kn">from</span> <span class="nn">vulcanforge.auth.schema</span> <span class="kn">import</span> <span class="n">ACE</span>
<span class="kn">from</span> <span class="nn">vulcanforge.notification</span> <span class="kn">import</span> <span class="n">tasks</span> <span class="k">as</span> <span class="n">mail_tasks</span>
<span class="kn">from</span> <span class="nn">vulcanforge.notification.util</span> <span class="kn">import</span> <span class="n">gen_message_id</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">smart_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">strings_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a bytestring version of &#39;s&#39;, encoded as specified in &#39;encoding&#39;.</span>

<span class="sd">    If strings_only is True, don&#39;t convert (some) non-string-like objects.</span>

<span class="sd">    This function was borrowed from Django</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">strings_only</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">NoneType</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="c"># An Exception subclass containing non-ASCII data that doesn&#39;t</span>
                <span class="c"># know how to print itself properly. We shouldn&#39;t raise a</span>
                <span class="c"># further exception.</span>
                <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">smart_str</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">strings_only</span><span class="p">,</span>
                        <span class="n">errors</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span>
            <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">elif</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="s">&#39;utf-8&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">generate_smart_str</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">smart_str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">smart_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A version of Python&#39;s urllib.urlencode() function that can operate on</span>
<span class="sd">    unicode strings. The parameters are first case to UTF-8 encoded strings an</span>
<span class="sd">    then encoded as per normal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">generate_smart_str</span><span class="p">(</span><span class="n">params</span><span class="p">)])</span>


<span class="k">class</span> <span class="nc">ApiAuthMixIn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">authenticate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Validate timestamp</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">iso8601</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;api_timestamp&#39;</span><span class="p">])</span>
            <span class="n">timestamp_utc</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-</span> \
                            <span class="n">timestamp</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp_utc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="c"># Validate signature</span>
            <span class="n">api_signature</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;api_signature&#39;</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;api_signature&#39;</span><span class="p">)</span>
            <span class="n">string_to_sign</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">digest</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">string_to_sign</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">api_signature</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">sign_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">has_api_key</span> <span class="o">=</span> <span class="n">has_api_timestamp</span> <span class="o">=</span> <span class="n">has_api_signature</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;api_key&#39;</span><span class="p">:</span>
                <span class="n">has_api_key</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;api_timestamp&#39;</span><span class="p">:</span>
                <span class="n">has_api_timestamp</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;api_signature&#39;</span><span class="p">:</span>
                <span class="n">has_api_signature</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_api_key</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;api_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_api_timestamp</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;api_timestamp&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_api_signature</span><span class="p">:</span>
            <span class="n">string_to_sign</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">digest</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">string_to_sign</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;api_signature&#39;</span><span class="p">,</span> <span class="n">digest</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">get_capability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">ApiToken</span><span class="p">(</span><span class="n">MappedClass</span><span class="p">,</span> <span class="n">ApiAuthMixIn</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;api_token&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">unique_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">nonce</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">cryptographic_nonce</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">RelationProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ApiTicket</span><span class="p">(</span><span class="n">MappedClass</span><span class="p">,</span> <span class="n">ApiAuthMixIn</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;api_ticket&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
    <span class="n">PREFIX</span> <span class="o">=</span> <span class="s">&#39;tck&#39;</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ApiTicket</span><span class="o">.</span><span class="n">PREFIX</span> <span class="o">+</span> <span class="n">nonce</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">cryptographic_nonce</span><span class="p">)</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">capabilities</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">({</span><span class="nb">str</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
    <span class="n">mod_date</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">RelationProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">api_ticket</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_ticket</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">PREFIX</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_ticket</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">authenticate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">ApiAuthMixIn</span><span class="o">.</span><span class="n">authenticate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_capability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ServiceToken</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tokens for special forge services&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;service_token&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;api_key&#39;</span><span class="p">,</span> <span class="s">&#39;user_id&#39;</span><span class="p">]</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">cryptographic_nonce</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">RelationProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
                <span class="n">session</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>

    <span class="k">def</span> <span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">authenticate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">EmailAddress</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="n">re_format</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^.* &lt;(.*)&gt;$&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;email_address&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;stripped&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s">&#39;claimed_by_user_id&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s">&#39;stripped&#39;</span><span class="p">,</span> <span class="s">&#39;confirmed&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;stripped&#39;</span><span class="p">,</span> <span class="s">&#39;claimed_by_user_id&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_id&#39;</span><span class="p">,</span> <span class="s">&#39;stripped&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">before_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripped</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stripped</span> <span class="o">=</span> <span class="n">EmailAddress</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">claimed_by_user_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">confirmed</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_address</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">addr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stripped</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">claimed_by_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">claimed_by_user_id</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_id</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">canonical</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">stripped</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stripped</span><span class="o">=</span><span class="n">stripped</span><span class="p">,</span> <span class="n">claimed_by_user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span>
                <span class="n">stripped</span><span class="o">=</span><span class="n">stripped</span><span class="p">,</span>
                <span class="n">claimed_by_user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span><span class="p">,</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">addr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;gmail.com&#39;</span><span class="p">,</span> <span class="s">&#39;googlemail.com&#39;</span><span class="p">):</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;{}@{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">canonical</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">re_format</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mo</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">addr</span><span class="p">:</span>
            <span class="n">user</span><span class="p">,</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;nobody@example.com&#39;</span>

    <span class="k">def</span> <span class="nf">confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">remove</span><span class="p">({</span>
            <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;$ne&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">},</span>
            <span class="s">&#39;stripped&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripped</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">send_verification_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Sending verification link to </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">To verify the email address </span><span class="si">%s</span><span class="s"> belongs to the user </span><span class="si">%s</span><span class="s">,</span>
<span class="s">please visit the following URL:</span>

<span class="s">    </span><span class="si">%s</span><span class="s"></span>
<span class="s">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">claimed_by_user</span><span class="p">()</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
       <span class="n">g</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s">&#39;/auth/verify_addr&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Verification email:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">mail_tasks</span><span class="o">.</span><span class="n">sendmail</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">destinations</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">],</span>
            <span class="n">fromaddr</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">forgemail_return_path</span><span class="p">,</span>
            <span class="n">reply_to</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="s">&#39;Email address verification&#39;</span><span class="p">,</span>
            <span class="n">message_id</span><span class="o">=</span><span class="n">gen_message_id</span><span class="p">(),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OpenId</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;openid&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">claimed_by_user_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">display_identifier</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">display_identifier</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span>
                <span class="n">_id</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">display_identifier</span><span class="o">=</span><span class="n">display_identifier</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">claimed_by_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">claimed_by_user_id</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">claimed_by_user_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># pragma no cover</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">display_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display_identifier</span><span class="p">,</span>
                     <span class="n">open_ids</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">]),</span>
                <span class="n">make_project</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">claimed_by_user_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_id</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">AuthGlobals</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;auth_globals&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">next_uid</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">session</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>
        <span class="k">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DuplicateKeyError</span><span class="p">:</span>  <span class="c"># pragma no cover</span>
            <span class="n">session</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">r</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_next_uid</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">upsert</span><span class="p">()</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find_and_modify</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="p">{},</span> <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;$inc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;next_uid&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}},</span>
            <span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">next_uid</span>


<span class="k">class</span> <span class="nc">WorkspaceTab</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;workspace_tab&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">unique_indexes</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="s">&#39;href&#39;</span><span class="p">)]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
    <span class="n">href</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">),</span>
            <span class="s">&#39;user_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
            <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">Markup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">href</span><span class="p">),</span>
            <span class="s">&#39;order&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># moving tabs right of the deleted one to the left by one</span>
        <span class="n">tabs_to_the_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
            <span class="s">&#39;user_id&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="s">&#39;order&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;$gt&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">}</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tabs_to_the_right</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">order</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">WorkspaceTab</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">)</span>
        <span class="n">isnew</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">tab</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tab</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
                <span class="n">isnew</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DuplicateKeyError</span><span class="p">:</span>  <span class="c"># pragma no cover</span>
                <span class="n">session</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tab</span><span class="p">,</span> <span class="n">isnew</span>


<div class="viewcode-block" id="User"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User">[docs]</a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">SOLRIndexed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vulcan&#39;s representation of individual human users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SALT_LEN</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;user&#39;</span>
        <span class="sd">&quot;&quot;&quot;mongodb collection name&quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">solr_indexed_session</span>
        <span class="n">polymorphic_on</span> <span class="o">=</span> <span class="s">&#39;kind&#39;</span>
        <span class="n">polymorphic_identity</span> <span class="o">=</span> <span class="s">&#39;user&#39;</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;tool_data.sfx.userid&#39;</span><span class="p">,</span>
            <span class="s">&#39;needs_password_reset&#39;</span><span class="p">,</span>
            <span class="s">&#39;password_set_at&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">unique_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="s">&#39;os_id&#39;</span><span class="p">]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">os_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">type_s</span> <span class="o">=</span> <span class="s">&#39;User&#39;</span>
    <span class="sd">&quot;&quot;&quot;SOLR indexing object type&quot;&quot;&quot;</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Ming ODM polymorphism field&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">open_ids</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">([</span><span class="nb">str</span><span class="p">])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">tool_preferences</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">({</span><span class="nb">str</span><span class="p">:</span> <span class="p">{</span><span class="nb">str</span><span class="p">:</span> <span class="bp">None</span><span class="p">}})</span>
    <span class="n">tool_data</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">({</span><span class="nb">str</span><span class="p">:</span> <span class="p">{</span><span class="nb">str</span><span class="p">:</span> <span class="bp">None</span><span class="p">}})</span>  <span class="c"># entry point: prefs dict</span>
    <span class="n">validate_citizen</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">last_login</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">disabled</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Don&#39;t use directly, instead use the</span>
<span class="sd">    :py:meth:`~vulcanforge.auth.model.User.get_pref` and</span>
<span class="sd">    :py:meth:`~vulcanforge.auth.model.User.set_pref` methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">display_name</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">preferences</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">results_per_page</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">if_missing</span><span class="o">=</span><span class="mi">25</span><span class="p">),</span>
        <span class="n">email_address</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">),</span>
        <span class="n">email_format</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">),</span>
        <span class="n">autosubscribe</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">if_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">message_emails</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">if_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">login_landing_url</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
    <span class="p">))</span>

    <span class="n">user_fields</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">({</span><span class="nb">str</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>

    <span class="c">#workspace_tabs = FieldProperty([{str: None}], if_missing=[])</span>
    <span class="n">workspace_references</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">([</span><span class="nb">str</span><span class="p">],</span> <span class="n">if_missing</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">workspace_references_last_mod</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1978</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">public_key</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="n">needs_password_reset</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">password_set_at</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="n">old_password_hashes</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">([</span><span class="nb">str</span><span class="p">],</span> <span class="n">if_missing</span><span class="o">=</span><span class="p">[])</span>

    <span class="n">mission</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">interests</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">expertise</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">skype_name</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">public</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">content_agreed_artifacts</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">([</span><span class="nb">str</span><span class="p">],</span> <span class="n">if_missing</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">get_swift_cookies</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># created for ui element state persistence</span>
    <span class="n">state_preferences</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="p">{})</span>
    <span class="c">##################################################################</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: dictionary used for JSON format export</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">),</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;display_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
            <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">(),</span>
            <span class="s">&#39;icon_url&#39;</span><span class="p">:</span> <span class="n">Markup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">icon_url</span><span class="p">()),</span>
            <span class="s">&#39;public&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">public</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="User.index_dict"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.index_dict">[docs]</a>    <span class="k">def</span> <span class="nf">index_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: dictionary used for SOLR index entry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">_id_s</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">),</span>
            <span class="n">title_s</span><span class="o">=</span><span class="s">&#39;User </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">),</span>
            <span class="n">username_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">display_name_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">emails_s</span><span class="o">=</span><span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email_addresses</span><span class="p">),</span>
            <span class="n">mission_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mission</span><span class="p">,</span>
            <span class="n">interests_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interests</span><span class="p">,</span>
            <span class="n">expertise_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expertise</span><span class="p">,</span>
            <span class="n">public_b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">public</span><span class="p">,</span>
            <span class="n">disabled_b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disabled</span><span class="p">,</span>
            <span class="n">trustscore_f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trust_info</span><span class="p">[</span><span class="s">&#39;score&#39;</span><span class="p">]</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="User.is_culled"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.is_culled">[docs]</a>    <span class="k">def</span> <span class="nf">is_culled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">competition</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="User.email_addresses"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.email_addresses">[docs]</a>    <span class="k">def</span> <span class="nf">email_addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: a list of email addresses claimed by this user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">email</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">EmailAddress</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
                        <span class="s">&#39;claimed_by_user_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">})]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="User.workspace_tabs"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.workspace_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">workspace_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: A Ming (mongodb) query cursor of this user&#39;s workspace tabs</span>
<span class="sd">                 (bookmarks)</span>
<span class="sd">        :rtype: ming.Cursor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">WorkspaceTab</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
            <span class="s">&#39;user_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
        <span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span>
            <span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)</span>
        <span class="p">])</span>
</div>
    <span class="nd">@LazyProperty</span>
<div class="viewcode-block" id="User.trust_cache"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.trust_cache">[docs]</a>    <span class="k">def</span> <span class="nf">trust_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TrustCache</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.needs_agree_component"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.needs_agree_component">[docs]</a>    <span class="k">def</span> <span class="nf">needs_agree_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests if this user needs to agree to the Exchange content agreement for</span>
<span class="sd">        the given Exchange Component</span>

<span class="sd">        :param component: A VehicleForge Exchange Component object</span>
<span class="sd">        :param request: (optional)</span>

<span class="sd">        .. todo::</span>

<span class="sd">            remove VehicleFORGE logic from Vulcan class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">exchange_content_agreement_message</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;agreetoterms&#39;</span><span class="p">,</span> <span class="s">&#39;no&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">component</span><span class="o">.</span><span class="n">is_published</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">component</span><span class="o">.</span><span class="n">is_msd</span> <span class="ow">and</span> \
               <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_content_agreed_artifact</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">index_id</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="User.needs_agree_category"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.needs_agree_category">[docs]</a>    <span class="k">def</span> <span class="nf">needs_agree_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests if this user needs to agree to the Exchange content agreement for</span>
<span class="sd">        the given Exchange Term</span>

<span class="sd">        :param term: A VehicleForge Exchange Component Term</span>
<span class="sd">        :param request: (optional)</span>

<span class="sd">        .. todo::</span>

<span class="sd">            remove VehicleFORGE logic from Vulcan class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">exchange_content_agreement_message</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;agreetoterms&#39;</span><span class="p">,</span> <span class="s">&#39;no&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">term</span><span class="o">.</span><span class="n">is_msd</span> <span class="ow">and</span> \
               <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_content_agreed_artifact</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">index_id</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="User.has_content_agreed_artifact"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.has_content_agreed_artifact">[docs]</a>    <span class="k">def</span> <span class="nf">has_content_agreed_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">index_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_agreed_artifacts</span>
</div>
<div class="viewcode-block" id="User.content_agree_artifact"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.content_agree_artifact">[docs]</a>    <span class="k">def</span> <span class="nf">content_agree_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_agreed_artifacts</span><span class="p">:</span>
            <span class="n">artifact_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_agreed_artifacts</span>
            <span class="n">artifact_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_agreed_artifacts</span> <span class="o">=</span> <span class="n">artifact_id_list</span>
</div>
<div class="viewcode-block" id="User.initialize_workspace_tabs"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.initialize_workspace_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_workspace_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c"># Edit own profile</span>
        <span class="n">default_tabs</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Edit my profile&quot;</span><span class="p">,</span>
            <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
            <span class="s">&quot;href&quot;</span><span class="p">:</span> <span class="s">&quot;{url}profile/edit_profile&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">()),</span>
            <span class="s">&quot;state&quot;</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">}]</span>

        <span class="n">custom_tabs_from_config</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;custom_tabs&#39;</span><span class="p">,</span> <span class="s">&#39;[]&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_workspace_tabs</span><span class="p">(</span>
            <span class="n">custom_tabs_from_config</span> <span class="o">+</span> <span class="n">default_tabs</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.add_workspace_tabs"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.add_workspace_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">add_workspace_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab_descriptors</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">last_tab</span> <span class="o">=</span> <span class="n">WorkspaceTab</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
                <span class="s">&#39;user_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
            <span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">last_tab</span><span class="o">.</span><span class="n">order</span> <span class="k">if</span> <span class="n">last_tab</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tab_descriptors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
                <span class="n">tab</span><span class="p">,</span> <span class="n">isnew</span> <span class="o">=</span> <span class="n">WorkspaceTab</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">td</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isnew</span><span class="p">:</span>
                    <span class="n">tab</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
                    <span class="n">order</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WorkspaceTab</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="o">**</span><span class="n">td</span><span class="p">)</span>
                <span class="n">order</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">order</span>
</div>
<div class="viewcode-block" id="User.add_workspace_tab_for_project"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.add_workspace_tab_for_project">[docs]</a>    <span class="k">def</span> <span class="nf">add_workspace_tab_for_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">with_flash</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">is_user_project</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">tab_to_project</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(),</span>
            <span class="s">&quot;href&quot;</span><span class="p">:</span> <span class="s">&quot;{prefix}home/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">url</span><span class="p">()),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_workspace_tabs</span><span class="p">([</span><span class="n">tab_to_project</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">with_flash</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&#39;A Tab to &lt;i&gt;{project_name}&lt;/i&gt; was added&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">project_name</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="User.delete_workspace_tab_to_url"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.delete_workspace_tab_to_url">[docs]</a>    <span class="k">def</span> <span class="nf">delete_workspace_tab_to_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">WorkspaceTab</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tab</span><span class="p">:</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="User.delete_workspace_tab_for_project"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.delete_workspace_tab_for_project">[docs]</a>    <span class="k">def</span> <span class="nf">delete_workspace_tab_for_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_workspace_tab_to_url</span><span class="p">(</span><span class="s">&quot;{prefix}home/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">url</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="User.get_trust_info"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_trust_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_trust_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">force_update</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trust_cache</span><span class="o">.</span><span class="n">needs_update</span><span class="p">():</span>
            <span class="n">reputation</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">percentile</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">trustforge_request</span><span class="p">(</span>
                <span class="s">&#39;get&#39;</span><span class="p">,</span>
                <span class="s">&#39;user/reputation/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">reputation</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;reputation&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">percentile</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;percentile&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trust_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reputation</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>

        <span class="n">trust_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;score&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trust_cache</span><span class="o">.</span><span class="n">reputation</span><span class="p">,</span>
            <span class="s">&quot;percentile&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trust_cache</span><span class="o">.</span><span class="n">percentile</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">trust_data</span>
</div>
    <span class="nd">@LazyProperty</span>
<div class="viewcode-block" id="User.trust_info"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.trust_info">[docs]</a>    <span class="k">def</span> <span class="nf">trust_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_info</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="User.get_trust_history"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_trust_history">[docs]</a>    <span class="k">def</span> <span class="nf">get_trust_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">trustforge_request</span><span class="p">(</span>
            <span class="s">&#39;get&#39;</span><span class="p">,</span>
            <span class="s">&#39;user/reputation_history/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;history&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">history</span>
</div>
    <span class="nd">@LazyProperty</span>
<div class="viewcode-block" id="User.trust_history"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.trust_history">[docs]</a>    <span class="k">def</span> <span class="nf">trust_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_history</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="User.index_text_objects"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.index_text_objects">[docs]</a>    <span class="k">def</span> <span class="nf">index_text_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expertise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interests</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="User.get_read_roles"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_read_roles">[docs]</a>    <span class="k">def</span> <span class="nf">get_read_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_project</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_project</span><span class="p">()</span><span class="o">.</span><span class="n">get_read_roles</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s">&#39;authenticated&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="User.get_pref"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_pref">[docs]</a>    <span class="k">def</span> <span class="nf">get_pref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pref_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pref_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="n">pref_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pref_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.set_pref"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.set_pref">[docs]</a>    <span class="k">def</span> <span class="nf">set_pref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pref_name</span><span class="p">,</span> <span class="n">pref_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pref_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="n">pref_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pref_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pref_name</span><span class="p">,</span> <span class="n">pref_value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.url"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.url">[docs]</a>    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a URL for this User.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;/u/{}/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="User.icon_url"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.icon_url">[docs]</a>    <span class="k">def</span> <span class="nf">icon_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">gravatar_kwargs</span><span class="p">):</span>
        <span class="n">user_project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_project</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user_project</span> <span class="ow">and</span> <span class="n">user_project</span><span class="o">.</span><span class="n">icon</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;/u/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;/user_icon&#39;</span>
        <span class="n">email_address</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">email_address</span> <span class="ow">or</span>
                         <span class="s">&quot;{}@vulcanforge.org&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">gravatar</span><span class="p">(</span><span class="n">email_address</span><span class="p">,</span> <span class="o">**</span><span class="n">gravatar_kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.landing_url"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.landing_url">[docs]</a>    <span class="k">def</span> <span class="nf">landing_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the URL this User should be redirected to upon login.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">landing_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;login_landing_url&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">landing_url</span><span class="p">:</span>
            <span class="n">landing_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s">&#39;login_landing_url&#39;</span><span class="p">,</span> <span class="s">&#39;/dashboard/activity_feed/&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">landing_url</span>
</div>
<div class="viewcode-block" id="User.registration_neighborhood"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.registration_neighborhood">[docs]</a>    <span class="k">def</span> <span class="nf">registration_neighborhood</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.neighborhood.model</span> <span class="kn">import</span> <span class="n">Neighborhood</span>
        <span class="n">nbhd_prefix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;registration_neighborhood&#39;</span><span class="p">,</span> <span class="s">&#39;projects&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Neighborhood</span><span class="o">.</span><span class="n">by_prefix</span><span class="p">(</span><span class="n">nbhd_prefix</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.store_old_password_hash"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.store_old_password_hash">[docs]</a>    <span class="k">def</span> <span class="nf">store_old_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">hash</span><span class="p">):</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;auth.pw.generations&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_password_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_password_hashes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_password_hashes</span><span class="p">[</span><span class="o">-</span><span class="n">generations</span><span class="p">:]</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.active_count"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.active_count">[docs]</a>    <span class="k">def</span> <span class="nf">active_count</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the total number of active users.</span>

<span class="sd">        &#39;active&#39; for now means that a user is not &#39;anonymous&#39;, &#39;root&#39; or</span>
<span class="sd">        &#39;admin&#39;</span>

<span class="sd">        :return: Number of active users</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">solr</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="s">&#39;type_s:(User)&#39;</span><span class="p">,</span>
            <span class="s">&#39;NOT username_s:(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="s">&#39; OR &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;anonymous&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;admin&#39;</span><span class="p">))</span>
        <span class="p">)))</span>
        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">hits</span>
</div>
<div class="viewcode-block" id="User.active"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.active">[docs]</a>    <span class="k">def</span> <span class="nf">active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_real_user</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disabled</span>
</div>
<div class="viewcode-block" id="User.is_real_user"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.is_real_user">[docs]</a>    <span class="k">def</span> <span class="nf">is_real_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;*anonymous&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;admin&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.upsert"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.upsert">[docs]</a>    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or create a user object for the given username.</span>

<span class="sd">        :param username:</span>
<span class="sd">        :type username: basestring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">u</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            <span class="n">session</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DuplicateKeyError</span><span class="p">:</span>
            <span class="n">session</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.by_email_address"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.by_email_address">[docs]</a>    <span class="k">def</span> <span class="nf">by_email_address</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">email_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lookup a User object by an email address.</span>

<span class="sd">        :param email_address: The email address to search for</span>
<span class="sd">        :type email_address: basestring</span>
<span class="sd">        :return: A :class:`User` object or ``None``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">EmailAddress</span><span class="o">.</span><span class="n">by_address</span><span class="p">(</span><span class="n">email_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ea</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">ea</span><span class="o">.</span><span class="n">claimed_by_user</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.by_username"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.by_username">[docs]</a>    <span class="k">def</span> <span class="nf">by_username</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">anonymous</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.by_display_name"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.by_display_name">[docs]</a>    <span class="k">def</span> <span class="nf">by_display_name</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;(?i)</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">name_regex</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">users</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.by_id"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.by_id">[docs]</a>    <span class="k">def</span> <span class="nf">by_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="n">_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.get_tool_data"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_tool_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_tool_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.set_tool_data"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.set_tool_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_tool_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">soil</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="User.address_object"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.address_object">[docs]</a>    <span class="k">def</span> <span class="nf">address_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">EmailAddress</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">stripped</span><span class="o">=</span><span class="n">EmailAddress</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span>
            <span class="n">claimed_by_user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="User.openid_object"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.openid_object">[docs]</a>    <span class="k">def</span> <span class="nf">openid_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OpenId</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="n">oid</span><span class="p">,</span> <span class="n">claimed_by_user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.claim_openid"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.claim_openid">[docs]</a>    <span class="k">def</span> <span class="nf">claim_openid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid_url</span><span class="p">):</span>
        <span class="n">oid_obj</span> <span class="o">=</span> <span class="n">OpenId</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="n">oid_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;display_name&#39;</span><span class="p">))</span>
        <span class="n">oid_obj</span><span class="o">.</span><span class="n">claimed_by_user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
        <span class="k">if</span> <span class="n">oid_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_ids</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oid_url</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.claim_address"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.claim_address">[docs]</a>    <span class="k">def</span> <span class="nf">claim_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_address</span><span class="p">,</span> <span class="n">confirmed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">is_primary</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">EmailAddress</span><span class="o">.</span><span class="n">canonical</span><span class="p">(</span><span class="n">email_address</span><span class="p">)</span>
        <span class="n">email_addr</span> <span class="o">=</span> <span class="n">EmailAddress</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">confirmed</span><span class="p">:</span>
            <span class="n">email_addr</span><span class="o">.</span><span class="n">confirm</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_primary</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_pref</span><span class="p">(</span><span class="s">&#39;email_address&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.register"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">make_project</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">neighborhood</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new user.</span>

<span class="sd">        :return: instance of ``cls`` (:class:`User` or a subclass thereof)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.neighborhood.model</span> <span class="kn">import</span> <span class="n">Neighborhood</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">auth_provider</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;display_name&#39;</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_pref</span><span class="p">(</span><span class="s">&#39;display_name&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">[</span><span class="s">&#39;display_name&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">os_id</span> <span class="o">=</span> <span class="n">ForgeGlobals</span><span class="o">.</span><span class="n">inc_user_counter</span><span class="p">()</span>
            <span class="n">user</span><span class="o">.</span><span class="n">initialize_workspace_tabs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">make_project</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Neighborhood</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Users&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">register_project</span><span class="p">(</span>
                <span class="s">&#39;u/&#39;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">user_project</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Allow for special user-only tools</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_extra_tool_status</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">user</span>
</div>
<div class="viewcode-block" id="User.private_project"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.private_project">[docs]</a>    <span class="k">def</span> <span class="nf">private_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.project.model</span> <span class="kn">import</span> <span class="n">Project</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Project</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">shortname</span><span class="o">=</span><span class="s">&#39;u/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">S</span><span class="o">.</span><span class="n">Invalid</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s">&#39;Error retrieving private_project for </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="User.script_name"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.script_name">[docs]</a>    <span class="k">def</span> <span class="nf">script_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;/u/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
</div>
<div class="viewcode-block" id="User.get_role_ids"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_role_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_role_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all of the User&#39;s ProjectRole IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">role_cache</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">user_roles</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">role_cache</span><span class="o">.</span><span class="n">reaching_ids_set</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.make_public"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.make_public">[docs]</a>    <span class="k">def</span> <span class="nf">make_public</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.project.model</span> <span class="kn">import</span> <span class="n">ProjectRole</span>

        <span class="n">user_project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_project</span><span class="p">()</span>
        <span class="n">read_roles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ProjectRole</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="s">&#39;*authenticated&#39;</span><span class="p">,</span> <span class="n">user_project</span><span class="p">)</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
            <span class="n">ProjectRole</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="s">&#39;*anonymous&#39;</span><span class="p">,</span> <span class="n">user_project</span><span class="p">)</span><span class="o">.</span><span class="n">_id</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">ace</span> <span class="ow">in</span> <span class="n">user_project</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ace</span><span class="o">.</span><span class="n">role_id</span> <span class="ow">in</span> <span class="n">read_roles</span> <span class="ow">and</span> <span class="n">ace</span><span class="o">.</span><span class="n">access</span> <span class="o">==</span> <span class="n">ACE</span><span class="o">.</span><span class="n">ALLOW</span>\
            <span class="ow">and</span> <span class="n">ace</span><span class="o">.</span><span class="n">permission</span> <span class="o">==</span> <span class="s">&#39;read&#39;</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_project</span><span class="o">.</span><span class="n">acl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ACE</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="n">read_roles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;read&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="User.make_private"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.make_private">[docs]</a>    <span class="k">def</span> <span class="nf">make_private</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.project.model</span> <span class="kn">import</span> <span class="n">ProjectRole</span>

        <span class="n">user_project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_project</span><span class="p">()</span>
        <span class="n">read_roles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ProjectRole</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="s">&#39;*authenticated&#39;</span><span class="p">,</span> <span class="n">user_project</span><span class="p">)</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
            <span class="n">ProjectRole</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="s">&#39;*anonymous&#39;</span><span class="p">,</span> <span class="n">user_project</span><span class="p">)</span><span class="o">.</span><span class="n">_id</span>
        <span class="p">]</span>
        <span class="n">user_project</span><span class="o">.</span><span class="n">acl</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ace</span> <span class="k">for</span> <span class="n">ace</span> <span class="ow">in</span> <span class="n">user_project</span><span class="o">.</span><span class="n">acl</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ace</span><span class="o">.</span><span class="n">role_id</span> <span class="ow">in</span> <span class="n">read_roles</span> <span class="ow">and</span> <span class="n">ace</span><span class="o">.</span><span class="n">access</span> <span class="o">==</span> <span class="n">ACE</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="User.get_roles"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_roles">[docs]</a>    <span class="k">def</span> <span class="nf">get_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all of the User&#39;s ProjectRoles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.project.model</span> <span class="kn">import</span> <span class="n">ProjectRole</span>

        <span class="k">return</span> <span class="n">ProjectRole</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;$in&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_role_ids</span><span class="p">()}})</span>
</div>
<div class="viewcode-block" id="User.my_projects"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.my_projects">[docs]</a>    <span class="k">def</span> <span class="nf">my_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the projects for which this user has a named role.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reaching_roles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roles</span><span class="p">()</span>
        <span class="n">named_roles</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reaching_roles</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">seen_project_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">named_roles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">project_id</span> <span class="ow">in</span> <span class="n">seen_project_ids</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">r</span><span class="o">.</span><span class="n">project</span>
            <span class="n">seen_project_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="User.set_password"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.set_password">[docs]</a>    <span class="k">def</span> <span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span> <span class="n">as_admin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">set_time</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change this User&#39;s password.</span>

<span class="sd">        :param new_password: plaintext password</span>
<span class="sd">        :type new_password: basestring</span>
<span class="sd">        :param as_admin: passed to the authentication provider</span>
<span class="sd">                         (for instance as required by LDAP)</span>
<span class="sd">        :type as_admin: bool</span>
<span class="sd">        :param set_time: update the ``password_set_at`` and</span>
<span class="sd">                         ``needs_password_reset`` fields of this User</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">auth_provider</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span> <span class="n">as_admin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password_set_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">needs_password_reset</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="User.get_workspace_tabs"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_workspace_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">get_workspace_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: JSON string of this User&#39;s workspace tabs (bookmarks)</span>
<span class="sd">        :rtype: str | unicode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">__json__</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_tabs</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="User.get_workspace_references"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_workspace_references">[docs]</a>    <span class="k">def</span> <span class="nf">get_workspace_references</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">references</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ref_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_references</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_workspace_reference</span><span class="p">(</span><span class="n">ref_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
                <span class="n">references</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

        <span class="n">last_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_references_last_mod</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;contents&#39;</span><span class="p">:</span> <span class="n">references</span><span class="p">,</span>
            <span class="s">&#39;last_mod&#39;</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">stringify_datetime</span><span class="p">(</span><span class="n">last_mod</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="k">def</span> <span class="nf">_make_workspace_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_id</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.artifact.widgets</span> <span class="kn">import</span> <span class="n">short_artifact_link_data</span>
        <span class="n">artifact</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">artifact</span><span class="o">.</span><span class="n">get_artifact_by_index_id</span><span class="p">(</span><span class="n">ref_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">artifact</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">short_artifact_link_data</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.anonymous"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.anonymous">[docs]</a>    <span class="k">def</span> <span class="nf">anonymous</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the *anonymous* user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="User.is_anonymous"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.is_anonymous">[docs]</a>    <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test if this User is the *anonymous* user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="User.email_address_header"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.email_address_header">[docs]</a>    <span class="k">def</span> <span class="nf">email_address_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;display_name&#39;</span><span class="p">))</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39;&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_email_address</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">h</span>
</div>
<div class="viewcode-block" id="User.get_email_address"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_email_address">[docs]</a>    <span class="k">def</span> <span class="nf">get_email_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get this User&#39;s primary email address</span>

<span class="sd">        :rtype: str | unicode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">from_pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;email_address&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_pref</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">from_pref</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_addresses</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="User.registration_time"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.registration_time">[docs]</a>    <span class="k">def</span> <span class="nf">registration_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">:</span>
            <span class="n">reg_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">generation_time</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg_time</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">reg_time</span>
</div>
<div class="viewcode-block" id="User.get_profile_info"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_profile_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_profile_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&quot;fullName&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
            <span class="s">&quot;profileImage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_url</span><span class="p">(),</span>
            <span class="s">&quot;username&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&quot;trustInfo&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trust_info</span><span class="p">,</span>
            <span class="s">&quot;mission&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission</span><span class="p">,</span>
            <span class="s">&quot;interests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">interests</span><span class="p">,</span>
            <span class="s">&quot;expertise&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">expertise</span><span class="p">,</span>
            <span class="s">&quot;skypeName&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">skype_name</span><span class="p">,</span>
            <span class="s">&quot;userSince&quot;</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">ago_ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registration_time</span><span class="p">),</span>
            <span class="s">&quot;projects&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">shortname</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_projects</span><span class="p">()</span>
                         <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">is_real</span><span class="p">()]</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="User.delete_account"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.delete_account">[docs]</a>    <span class="k">def</span> <span class="nf">delete_account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disables user and resigns from all projects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_projects</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">neighborhood</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;Users&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">users</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">project</span><span class="o">.</span><span class="n">delete_project</span><span class="p">()</span>
                <span class="n">project</span><span class="o">.</span><span class="n">user_leave_project</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="User.get_swift_params"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.get_swift_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_swift_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_new</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">force_new</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">StaticResourceToken</span><span class="o">.</span><span class="n">new_from_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">StaticResourceToken</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">dep_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;swift.auth.deployment_param&#39;</span><span class="p">,</span> <span class="s">&#39;vfdkey&#39;</span><span class="p">)</span>
        <span class="n">tok_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;swift.auth.token_param&#39;</span><span class="p">,</span> <span class="s">&#39;vf_swift_token&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dep_key</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;swift.auth.deployment_id&#39;</span><span class="p">],</span>
            <span class="n">tok_key</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">api_key</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">params</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="User.swift_params"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.swift_params">[docs]</a>    <span class="k">def</span> <span class="nf">swift_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_swift_params</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="User.swift_cookie_url"><a class="viewcode-back" href="../../../user.html#vulcanforge.auth.model.User.swift_cookie_url">[docs]</a>    <span class="k">def</span> <span class="nf">swift_cookie_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unset_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;{base_url}swiftvf/set_cookie?{query}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">base_s3_url</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swift_params</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">unset_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_swift_cookies</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span>

</div></div>
<span class="k">class</span> <span class="nc">TrustCache</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>
    <span class="n">TRUSTDATE_FREQUENCY</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;trustcache&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">last_update</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">reputation</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">percentile</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">session</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">def</span> <span class="nf">needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRUSTDATE_FREQUENCY</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reputation</span><span class="p">,</span> <span class="n">percentile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reputation</span> <span class="o">=</span> <span class="n">reputation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentile</span> <span class="o">=</span> <span class="n">percentile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PasswordResetToken</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;password_reset_token&#39;</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;user_id&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s">&#39;nonce&#39;</span><span class="p">,)]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">expiry_date</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">_user</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry_date</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">expired</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>

    <span class="k">def</span> <span class="nf">reset_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s">&#39;/auth/password_reset&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Invalid password reset: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Sending password reset link to </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;auth/mail/password_reset.txt&#39;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">({</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_url</span><span class="p">(),</span>
            <span class="s">&#39;forge_name&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forge_name&#39;</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Password reset email:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">mail_tasks</span><span class="o">.</span><span class="n">sendmail</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">destinations</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">],</span>
            <span class="n">fromaddr</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">forgemail_return_path</span><span class="p">,</span>
            <span class="n">reply_to</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="s">&#39;Reset your {} password&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forge_name&#39;</span><span class="p">,</span> <span class="s">&#39;forge&#39;</span><span class="p">)),</span>
            <span class="n">message_id</span><span class="o">=</span><span class="n">gen_message_id</span><span class="p">(),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">UserRegistrationToken</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;user_registration&#39;</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;email_address&#39;</span><span class="p">,</span> <span class="s">&#39;nonce&#39;</span><span class="p">]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>  <span class="c"># User&#39;s name</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">user_fields</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">({</span><span class="nb">str</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
    <span class="n">registration_url</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">nonce</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">expiry_date</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="n">approved_already</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># adds user to project on registration</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">email_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;{} User Registration&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forge_name&#39;</span><span class="p">,</span> <span class="s">&#39;Forge&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry_date</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="ow">not</span> <span class="n">expired</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_text</span>
        <span class="n">mail_tasks</span><span class="o">.</span><span class="n">sendmail</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">fromaddr</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">forgemail_return_path</span><span class="p">,</span>
            <span class="n">destinations</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">],</span>
            <span class="n">reply_to</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email_subject</span><span class="p">,</span>
            <span class="n">message_id</span><span class="o">=</span><span class="n">gen_message_id</span><span class="p">(),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span>
        <span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;User registration email:</span><span class="se">\n</span><span class="s">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">email_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;auth/mail/user_registration.txt&#39;</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registration_url</span> <span class="ow">or</span> <span class="s">&#39;/auth/register&#39;</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">({</span>
            <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">),</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s">&#39;forge_name&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forge_name&#39;</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="nd">@LazyProperty</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">vulcanforge.project.model</span> <span class="kn">import</span> <span class="n">Project</span>
        <span class="k">return</span> <span class="n">Project</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EmailChangeToken</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;email_change_notification&#39;</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;email_address&#39;</span><span class="p">,</span> <span class="s">&#39;nonce&#39;</span><span class="p">]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">old_email</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">new_email</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">cryptographic_nonce</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">created_date</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span>
                                 <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
    <span class="n">expiry_date</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry_date</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">expired</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>

    <span class="k">def</span> <span class="nf">reset_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s">&#39;/auth/cancel_email_modification&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Invalid email change reversion: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Sending email change reversion link to </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_email</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
            <span class="s">&#39;auth/mail/email_change_reversion.txt&#39;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">({</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;old_email&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_email</span><span class="p">,</span>
            <span class="s">&#39;new_email&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_email</span><span class="p">,</span>
            <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_url</span><span class="p">(),</span>
            <span class="s">&#39;forge_name&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forge_name&#39;</span><span class="p">,</span> <span class="s">&quot;Forge&quot;</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Email change email:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">mail_tasks</span><span class="o">.</span><span class="n">sendmail</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">destinations</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">old_email</span><span class="p">],</span>
            <span class="n">fromaddr</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">forgemail_return_path</span><span class="p">,</span>
            <span class="n">reply_to</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="s">&#39;{} Email Modification&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forge_name&#39;</span><span class="p">,</span> <span class="s">&#39;Forge&#39;</span><span class="p">)),</span>
            <span class="n">message_id</span><span class="o">=</span><span class="n">gen_message_id</span><span class="p">(),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">StaticResourceToken</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tokens for swift auth&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;swift_token&#39;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;api_key&#39;</span><span class="p">,</span> <span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;expires&#39;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">)]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">ForeignIdProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">cryptographic_nonce</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">RelationProperty</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">new_from_user</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="n">session</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
            <span class="s">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">_id</span>
        <span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s">&#39;expires&#39;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
                <span class="n">token</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">new_from_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>

    <span class="k">def</span> <span class="nf">refresh_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">cryptographic_nonce</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">authenticate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">UsersDenied</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;users_denied&#39;</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FailedLogin</span><span class="p">(</span><span class="n">BaseMappedClass</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">__mongometa__</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">main_orm_session</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;failed_login&#39;</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;client&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="s">&#39;timestamp&#39;</span><span class="p">]</span>

    <span class="n">_id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_locked</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether logins for current client are locked&quot;&quot;&quot;</span>
        <span class="n">max_fails</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;login_lock.num&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_fails</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_client_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">client</span> <span class="ow">and</span> <span class="n">cls</span><span class="o">.</span><span class="n">num_recent</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_fails</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_client_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">get_client_ip</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">num_recent</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;login_lock.interval&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
            <span class="s">&#39;client&#39;</span><span class="p">:</span> <span class="n">client</span><span class="p">,</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;$gt&#39;</span><span class="p">:</span> <span class="n">cutoff</span><span class="p">}</span>
        <span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_request</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">get_client_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
            <span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo-64.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Vulcan 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, ISIS.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>